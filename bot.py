import asyncio
import json
import logging
import random
from datetime import datetime, timedelta

from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton


# ==========================================
#                –ù–ê–°–¢–†–û–ô–ö–ò
# ==========================================

BOT_TOKEN = "8509439078:AAE0PBI_gzetGm21SauqceAQ8a_km9NNAe8"
OWNER_ID = 128055849

DATA_FILE = "wish_users.json"

# –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
WISHES_DEFAULT = [
    "–ï—Å–ª–∏ —Ç—ã –∂–¥–∞–ª –∑–Ω–∞–∫ ‚Äî –≤–æ—Ç –æ–Ω ‚ú®",
    "–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥.",
    "–ù–µ –≤—Å—ë —Å—Ä–∞–∑—É ‚Äî –Ω–æ –≤—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ.",
    "–¢—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è –ª—É—á—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å.",
    "–ò–Ω–æ–≥–¥–∞ –≤–∞–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∏–¥—Ç–∏.",
    "–î–µ–ª–∞–π, —á—Ç–æ –º–æ–∂–µ—à—å ‚Äî —ç—Ç–æ–≥–æ —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤—ã–π —à–∞–Ω—Å.",
    "–£–ª—ã–±–Ω–∏—Å—å. –¢–µ–±–µ –∏–¥—ë—Ç üòä",
    "–ú–∏—Ä –≤—Å–µ–≥–¥–∞ —á—É—Ç—å —Ç–µ–ø–ª–µ–µ, –∫–æ–≥–¥–∞ —Ç—ã –Ω–µ —Å–¥–∞—ë—à—å—Å—è.",
    "–¢—ã —É–∂–µ –ø—Ä–æ—à—ë–ª(–ª–∞) –±–æ–ª—å—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å.",
    "–ì–æ—Ä–∞ –≤—ã–≥–ª—è–¥–∏—Ç –≤—ã—Å–æ–∫–æ–π —Ç–æ–ª—å–∫–æ —Å–Ω–∏–∑—É.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é –≤–µ—â—å –¥–ª—è —Å–µ–±—è.",
    "–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è.",
    "–¢—ã –∏–º–µ–µ—à—å –ø—Ä–∞–≤–æ –æ—Ç–¥—ã—Ö–∞—Ç—å.",
    "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–µ —Ä—É–≥–∞—Ç—å —Å–µ–±—è.",
    "–¢—ã –≤–∞–∂–µ–Ω(–∞). –î–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –æ—â—É—â–∞–µ—Ç—Å—è.",
    "–ñ–∏–∑–Ω—å ‚Äî –Ω–µ –≥–æ–Ω–∫–∞. –î–≤–∏–≥–∞–π—Å—è –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ.",
    "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω(–∞) –±—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º —Å–µ–≥–æ–¥–Ω—è.",
    "–¢—ã –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–µ–Ω ‚Äî –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ.",
    "–¢—ã —Ç–æ—á–Ω–æ —Å–ø—Ä–∞–≤–∏—à—å—Å—è.",
    "–ü–æ–∑–∞–±–æ—Ç—å—Å—è –æ —Å–µ–±–µ ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ.",
    "–ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º –≤—Å–µ–≥–¥–∞.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–∏–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å.",
    "–¢—ã –¥–µ–ª–∞–µ—à—å –≤—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ–µ ‚Äî –∏ —ç—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
    "–î–∞–π —Å–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ —Ç–µ–ø–ª–∞ —Å–µ–≥–æ–¥–Ω—è.",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∞—á–∞–ª–æ–º.",
    "–¢—ã –¥–æ—Å—Ç–æ–∏–Ω(–∞) –ª—É—á—à–µ–≥–æ.",
    "–¢—ã –∏–º–µ–µ—à—å –ø—Ä–∞–≤–æ –Ω–∞ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.",
    "–¢—ã –Ω–µ –æ–¥–∏–Ω(–æ–¥–Ω–∞), –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–∫ –∫–∞–∂–µ—Ç—Å—è.",
    "–í–µ—Ä—å –≤ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ ‚Äî –æ–Ω–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º.",
    "–°–µ–≥–æ–¥–Ω—è —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –º–∞–ª–µ–Ω—å–∫–æ–µ, –Ω–æ –≤–∞–∂–Ω–æ–µ –¥–ª—è —Å–µ–±—è.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–¥–∞–≤–∞—Ç—å—Å—è.",
    "–¢—ã —É–∂–µ —Å–ø—Ä–∞–≤–ª—è–ª—Å—è(–∞—Å—å) ‚Äî —Å–ø—Ä–∞–≤–∏—à—å—Å—è –∏ —Å–µ–π—á–∞—Å.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –Ω–∞–π–¥—ë—Ç—Å—è –º–∏–Ω—É—Ç–∫–∞ –¥–ª—è —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è.",
    "–£ —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∞–≤–æ –Ω–∞ –æ—Ç–¥—ã—Ö, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–µ–ª–∞ –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω—ã.",
    "–û–¥–Ω–æ –¥–æ–±—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Å–µ–±—è ‚Äî —É–∂–µ –ø–æ–±–µ–¥–∞.",
    "–¢–≤–æ–∏ —É—Å–∏–ª–∏—è –≤–∞–∂–Ω—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Ö –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç.",
    "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –±—ã—Ç—å –∫ —Å–µ–±–µ –º—è–≥—á–µ.",
    "–¢—ã –º–æ–∂–µ—à—å –∏–¥—Ç–∏ –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ ‚Äî –Ω–µ –≤ —á—É–∂–æ–º.",
    "–¢—ã –¥–µ–ª–∞–µ—à—å –≤—Å—ë, —á—Ç–æ –º–æ–∂–µ—à—å. –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
    "–ò–Ω–æ–≥–¥–∞ —Ç–∏—à–∏–Ω–∞ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º.",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–æ–¥–∞—Ä–∏—Ç —Ç–µ–±–µ —á—Ç–æ-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–µ, –ø—É—Å—Ç—å –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–æ–µ.",
    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏ ‚Äî —Ç—ã –∏–¥—ë—à—å –ø–æ —Å–≤–æ–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–≥–µ.",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è, —Ç–µ–ø–ª–∞ –∏ –∑–∞–±–æ—Ç—ã.",
    "–í—Å—ë, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ.",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –æ—â—É—â–∞–µ—à—å –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.",
    "–¢–µ–±–µ –Ω–µ –Ω—É–∂–Ω–æ –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Ç—å —Å–æ–±–æ–π.",
    "–°–µ–≥–æ–¥–Ω—è –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–¥–æ—Å—Ç–∏.",
    "–ò–Ω–æ–≥–¥–∞ —à–∞–≥ –Ω–∞–∑–∞–¥ ‚Äî —Ç–æ–∂–µ —à–∞–≥.",
    "–¢—ã –≤–∞–∂–µ–Ω(–∞) –¥–ª—è –º–∏—Ä–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å.",
    "–î–∞–π —Å–µ–±–µ –≤—Ä–µ–º—è. –ë–æ–ª—å—à–∏–µ –ø–µ—Ä–µ–º–µ–Ω—ã —Ä–∞—Å—Ç—É—Ç –º–µ–¥–ª–µ–Ω–Ω–æ.",
    "–¢—ã –±–æ–ª—å—à–µ, —á–µ–º —Ç–≤–æ–∏ –æ—à–∏–±–∫–∏.",
    "–î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥.",
    "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –¥—ã—à–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ, —Ö–æ—Ç—è –±—ã –º–∏–Ω—É—Ç—É.",
    "–¢—ã –º–æ–∂–µ—à—å –≥–æ—Ä–¥–∏—Ç—å—Å—è —Ç–µ–º, –∫–∞–∫ –¥–∞–ª–µ–∫–æ —É–∂–µ –¥–æ—à—ë–ª(–ª–∞).",
    "–°–µ–≥–æ–¥–Ω—è –º–∏—Ä –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ ‚Äî –Ω–∞—á–Ω–∏ —Å —É–ª—ã–±–∫–∏.",
    "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω(–∞) –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º –≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–∏–π –≤—ã–±–æ—Ä ‚Äî –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
    "–¢—ã –¥–æ—Å—Ç–æ–∏–Ω(–∞) –∑–∞–±–æ—Ç—ã, –≤–Ω–∏–º–∞–Ω–∏—è –∏ —Ç–µ–ø–ª–∞.",
    "–í–µ—Ä—å –≤ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ ‚Äî –æ–Ω–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º.",
]

# –ú—è–≥–∫–∏–µ —Å–ø–æ–∫–æ–π–Ω—ã–µ
WISHES_SOFT = [
    "–°–µ–≥–æ–¥–Ω—è –±—É–¥—å –º—è–≥–∫–∏–º(–æ–π) –∫ —Å–µ–±–µ üíô",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –æ—Ç–¥—ã—Ö–∞.",
    "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è.",
    "–¢—ã –¥–µ–ª–∞–µ—à—å –≤—Å—ë, —á—Ç–æ –º–æ–∂–µ—à—å.",
    "–° —Ç–æ–±–æ–π –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ.",
    "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω(–∞) –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º —Å–µ–≥–æ–¥–Ω—è.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–∏–π –ø–ª–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∂–∏—Ç—å –¥–µ–Ω—å.",
    "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω(–∞) –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º.",
    "–î—ã—à–∏ –≥–ª—É–±–∂–µ. –í—Å—ë –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è.",
    "–¢—ã –Ω—É–∂–¥–∞–µ—à—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.",
]

# –ë–æ–ª–µ–µ –±–æ–¥—Ä—ã–µ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ
WISHES_BOLD = [
    "–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —à–∞–≥ –∫ –º–µ—á—Ç–µ üî•",
    "–¢—ã –º–æ–∂–µ—à—å –±–æ–ª—å—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å.",
    "–ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—à—å —Å –±–æ–ª—å—à–æ–≥–æ.",
    "–ï—Å–ª–∏ —Å—Ç—Ä–∞—à–Ω–æ ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ.",
    "–¢—ã —Å–ø–æ—Å–æ–±–µ–Ω —É–¥–∏–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.",
    "–ü–æ–ø—Ä–æ–±—É–π ‚Äî –∏ —É–≤–∏–¥–∏—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –±—ã–ª–æ –≤—á–µ—Ä–∞.",
    "–ö–∞–∂–¥–æ–µ —É—Å–∏–ª–∏–µ –Ω–µ –∑—Ä—è.",
    "–¢–≤–æ—ë –±—É–¥—É—â–µ–µ —Å–ø–∞—Å–∏–±–æ —Å–∫–∞–∂–µ—Ç –∑–∞ —ç—Ç–æ—Ç —à–∞–≥.",
    "–¢—ã –±–ª–∏–∂–µ –∫ —Ü–µ–ª–∏, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
]

# –û—Å–æ–±—ã–µ "—Ä–µ–¥–∫–∏–µ" –ø–æ–∂–µ–ª–∞–Ω–∏—è
SPECIAL_WISHES = [
    "–ò–Ω–æ–≥–¥–∞ –∂–∏–∑–Ω—å —É–ø—Ä—è–º–∞—è ‚Äî –Ω–æ —Ç—ã —É–ø—Ä—è–º–µ–µ üòâ",
    "–¢—ã –ø–µ—Ä–µ–∂–∏–ª(–∞) –º–Ω–æ–≥–æ–µ. –ò –≤—Å—ë –µ—â—ë —Å—Ç–æ–∏—à—å.",
    "–í–ø–µ—Ä–µ–¥–∏ —Ö–æ—Ä–æ—à–∏–µ –º–æ–º–µ–Ω—Ç—ã ‚Äî –∏—Ö –±–æ–ª—å—à–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–¢—ã –≤–∞–∂–µ–Ω(–∞) –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ä—è–¥–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∑–∞–º–µ—á–∞–µ—à—å.",
    "–¢–≤–æ—ë –±—É–¥—É—â–µ–µ –±—É–¥–µ—Ç —Å–≤–µ—Ç–ª–µ–µ, —á–µ–º —Ç–≤–æ–π –ø—Ä–æ—à–ª—ã–π –¥–µ–Ω—å.",
]

STYLES = ["default", "soft", "bold"]


# ==========================================
#  –•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• (–∫—É–ª–¥–∞—É–Ω + —Å—Ç—Ä–∏–∫)
# ==========================================

def load_data():
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return {}


def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)


users = load_data()


# ==========================================
#            –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ==========================================

def ensure_user(uid: int):
    uid = str(uid)
    if uid not in users:
        users[uid] = {
            "last_time": None,
            "last_wish": None,       # <--- –î–û–ë–ê–í–ò–õ–ò
            "streak": 0,
            "total": 0,
            "style": "default",
        }
        save_data(users)
    return users[uid]


def choose_wish(style: str, now: datetime, total: int) -> str:
    if total > 0 and total % 7 == 0:
        return random.choice(SPECIAL_WISHES)

    if style == "soft":
        base = WISHES_SOFT
    elif style == "bold":
        base = WISHES_BOLD
    else:
        base = WISHES_DEFAULT

    return random.choice(base)


def can_get_wish(data: dict, now: datetime):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞ 24 —á–∞—Å–∞."""
    last = data.get("last_time")
    if not last:
        return True, timedelta(0)

    last_dt = datetime.fromisoformat(last)
    delta = now - last_dt
    if delta >= timedelta(hours=24):
        return True, timedelta(0)
    return False, timedelta(hours=24) - delta


def apply_streak(data: dict, now: datetime):
    last = data.get("last_time")
    if not last:
        data["streak"] = 1
        return

    last_date = datetime.fromisoformat(last).date()
    today = now.date()

    if last_date == today - timedelta(days=1):
        data["streak"] += 1
    else:
        data["streak"] = 1


def register_wish_given(uid: str, now: datetime, wish: str):
    data = ensure_user(int(uid))
    apply_streak(data, now)
    data["last_time"] = now.isoformat()
    data["last_wish"] = wish          # <-- –∫–ª—é—á–µ–≤–æ–µ!
    data["total"] += 1
    save_data(users)
    return data


# ==========================================
#               –ö–õ–ê–í–ò–ê–¢–£–†–´
# ==========================================

def main_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚ú® –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ", callback_data="get_wish")],
            [
                InlineKeyboardButton(text="üé≠ –°—Ç–∏–ª—å", callback_data="set_style"),
                InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats"),
            ]
        ]
    )


def style_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚öñ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", callback_data="style:default")],
            [InlineKeyboardButton(text="üíô –ú—è–≥–∫–∏–π", callback_data="style:soft")],
            [InlineKeyboardButton(text="üî• –ë–æ–ª–µ–µ –±–æ–¥—Ä—ã–π", callback_data="style:bold")],
        ]
    )


# ==========================================
#                   /start
# ==========================================
bot = Bot(BOT_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    ensure_user(message.from_user.id)

    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑ –≤ –¥–µ–Ω—å –±—É–¥–µ—Ç –¥–∞—Ä–∏—Ç—å —Ç–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚ú®\n\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ:",
        reply_markup=main_keyboard()
    )


# ==========================================
#                  /stats
# ==========================================

@dp.callback_query(lambda c: c.data == "stats")
@dp.message(Command("stats"))
async def show_stats(obj):
    if isinstance(obj, types.CallbackQuery):
        message = obj.message
        user = obj.from_user
        await obj.answer()
    else:
        message = obj
        user = obj.from_user

    data = ensure_user(user.id)

    last = data["last_time"]
    last_str = last.replace("T", " ")[:16] if last else "–ï—â—ë –Ω–µ –±—ã–ª–æ"

    await message.answer(
        f"üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"üî• –°—Ç—Ä–∏–∫: {data['streak']} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥\n"
        f"üì® –í—Å–µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏–π: {data['total']}\n"
        f"üïí –ü–æ—Å–ª–µ–¥–Ω–µ–µ: {last_str}",
        reply_markup=main_keyboard()
    )


# ==========================================
#              –°–º–µ–Ω–∞ —Å—Ç–∏–ª—è –ø–æ–∂–µ–ª–∞–Ω–∏–π
# ==========================================

@dp.callback_query(lambda c: c.data == "set_style")
async def choose_style_menu(call: types.CallbackQuery):
    await call.message.answer(
        "–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –ø–æ–∂–µ–ª–∞–Ω–∏–π:",
        reply_markup=style_keyboard()
    )
    await call.answer()


@dp.callback_query(lambda c: c.data.startswith("style:"))
async def set_style(call: types.CallbackQuery):
    _, style = call.data.split(":", 1)
    data = ensure_user(call.from_user.id)

    if style not in STYLES:
        await call.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å!", show_alert=True)
        return

    data["style"] = style
    save_data(users)

    human = {
        "default": "‚öñ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
        "soft": "üíô –ú—è–≥–∫–∏–π",
        "bold": "üî• –ë–æ–¥—Ä—ã–π"
    }[style]

    await call.message.answer(f"–°—Ç–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞: {human}", reply_markup=main_keyboard())
    await call.answer("–ì–æ—Ç–æ–≤–æ!")


# ==========================================
#         –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è (–∫–Ω–æ–ø–∫–∞)
# ==========================================

@dp.callback_query(lambda c: c.data == "get_wish")
async def get_wish(call: types.CallbackQuery):
    uid = str(call.from_user.id)
    now = datetime.utcnow()
    data = ensure_user(call.from_user.id)

    # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if call.from_user.id == OWNER_ID:
        can_get = True
        remaining = timedelta(0)
    else:
        can_get, remaining = can_get_wish(data, now)

    # –ö–£–õ–î–ê–£–ù –ù–ï –ü–†–û–®–Å–õ
    if not can_get:
        hours = remaining.seconds // 3600
        minutes = (remaining.seconds % 3600) // 60

        # —Å–æ–∑–¥–∞—ë–º –ø–æ–∂–µ–ª–∞–Ω–∏–µ (–∫–∞–∫ –±—ã–ª–æ)
        wish = data.get("last_wish", "–í–∞—à–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ")

        text = (
            "–¢—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª(–∞) –ø–æ–∂–µ–ª–∞–Ω–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.\n\n"
            "–¢–≤–æ—ë –ø–æ–∂–µ–ª–∞–Ω–∏–µ:\n\n"
            f"¬´{wish}¬ª\n\n"
            f"üî• –¢–≤–æ–π —Å—Ç—Ä–∏–∫: {data['streak']} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥\n"
            f"üìä –í—Å–µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏–π: {data['total']}\n\n"
            f"–°–ª–µ–¥—É—é—â–µ–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ {hours}—á {minutes}–º–∏–Ω."
        )

        await call.message.answer(text, reply_markup=main_keyboard())
        await call.answer()
        return

    # –ú–û–ñ–ù–û –í–´–î–ê–¢–¨ –ù–û–í–û–ï
    style = data["style"]
    total_before = data["total"]

    wish = choose_wish(style, now, total_before)

    # –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    register_wish_given(uid, now, wish)

    await call.message.answer(
        f"¬´{wish}¬ª",
        reply_markup=main_keyboard()
    )
    await call.answer()


# ==========================================
#     –ê–í–¢–û–í–´–î–ê–ß–ê –ü–û–ñ–ï–õ–ê–ù–ò–ô –†–ê–ó –í 24 –ß–ê–°–ê
# ==========================================

async def auto_wish_loop():
    await asyncio.sleep(5)
    logging.info("–ê–≤—Ç–æ–ø–æ–∂–µ–ª–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã.")

    while True:
        now = datetime.utcnow()

        for uid, data in list(users.items()):
            if not data["last_time"]:
                continue

            can_get, remaining = can_get_wish(data, now)

            if can_get:
                style = data["style"]
                total_before = data["total"]

                wish = choose_wish(style, now, total_before)
                updated = register_wish_given(uid, now, wish)

                streak = updated["streak"]
                total = updated["total"]

                try:
                    await bot.send_message(
                        int(uid),
                        f"‚ú® –¢–≤–æ—ë –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ:\n\n"
                        f"¬´{wish}¬ª\n\n"
                        f"üî• –°—Ç—Ä–∏–∫: {streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥\n"
                        f"üìä –í—Å–µ–≥–æ: {total}"
                    )
                except Exception as e:
                    logging.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–ø–æ–∂–µ–ª–∞–Ω–∏–µ {uid}: {e}")

        await asyncio.sleep(600)


# ==========================================
#                  –ó–ê–ü–£–°–ö
# ==========================================

async def main():
    asyncio.create_task(auto_wish_loop())
    await dp.start_polling(bot)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    asyncio.run(main())

