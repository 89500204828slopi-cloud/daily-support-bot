import asyncio
import json
import os
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from dotenv import load_dotenv

# ---------------------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# ---------------------------------------------------------

load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = int(os.getenv("OWNER_ID", "128055849"))

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

DATA_FILE = "wish_users.json"

# ---------------------------------------------------------
# –ü–æ–∂–µ–ª–∞–Ω–∏—è
# ---------------------------------------------------------

WISHES = [
    "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —É—Ç—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è –º—è–≥–∫–æ.",
    "–ò–Ω–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞, –∏ —ç—Ç–æ–≥–æ —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
    "–í–Ω—É—Ç—Ä–∏ –≤—Å–µ–≥–¥–∞ –±–æ–ª—å—à–µ —Å–∏–ª, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–∞.",
    "–•–æ—Ä–æ—à–∏–µ –ø–µ—Ä–µ–º–µ–Ω—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ.",
    "–ú–æ–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –ø–µ—Ä–µ–¥—ã—à–∫—É.",
    "–°–µ–≥–æ–¥–Ω—è –ø–æ–¥–æ–π–¥—ë—Ç –¥–ª—è —á–µ–≥–æ-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ.",
    "–ü—É—Å—Ç—å –º—ã—Å–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º—è–≥—á–µ, –∞ —Å–µ—Ä–¥—Ü–µ —Ç–µ–ø–ª–µ–µ.",
    "–ü—É—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —à–∞–≥–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ.",
    "–ú–æ–∂–Ω–æ –æ–ø–µ—Ä–µ—Ç—å—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å.",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç —á—É—Ç—å –ª–µ–≥—á–µ.",
    "–í—Å—ë –Ω—É–∂–Ω–æ–µ —É–∂–µ —Ä—è–¥–æ–º.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –ø–æ–ª—É—á–∏—Ç—Å—è –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ –¥–æ–±—Ä–æ–µ."
    "–ü—Ä–æ—Å–∏–ª –∑–Ω–∞–∫ —Å–≤—ã—à–µ ‚Äî –¥–µ—Ä–∂–∏.",
    "–£—Å–ø–µ—Ö –Ω–µ–∏–∑–±–µ–∂–µ–Ω, –¥–∞–∂–µ –µ—Å–ª–∏ —à–∞–≥–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è –ª—É—á—à–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–í—Å–µ–ª–µ–Ω–Ω–∞—è —É–∂–µ –ø–æ–¥–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ –≤–µ—Ä—ã –≤ —Ö–æ—Ä–æ—à–µ–µ.",
    "–¢–≤–æ—è —Å–∏–ª–∞ —Ç–∏—à–µ, —á–µ–º —à—É–º –º—ã—Å–ª–µ–π, –Ω–æ –∫—É–¥–∞ –≥–ª—É–±–∂–µ.",
    "–•–æ—Ä–æ—à–µ–µ —É–∂–µ —Å–≤–µ—Ä–Ω—É–ª–æ –Ω–∞ —Ç–≤–æ—é —É–ª–∏—Ü—É.",
    "–°–µ–≥–æ–¥–Ω—è ‚Äî —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
    "–ú–æ–∂–Ω–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å. –ú–∏—Ä –ø–æ–¥–æ–∂–¥—ë—Ç.",
    "–¢–µ–ø–ª–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –≤ —Ç–µ –¥–Ω–∏, –∫–æ–≥–¥–∞ –µ–≥–æ –Ω–µ –∂–¥—ë—à—å.",
    "–¢—ã –±–ª–∏–∂–µ –∫ —Ü–µ–ª–∏, —á–µ–º –¥—É–º–∞–µ—à—å.",
    "–°–µ–≥–æ–¥–Ω—è –ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–æ–º–µ–Ω—Ç —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –º–∞–ª–µ–Ω—å–∫–æ–µ –∏ –¥–æ–±—Ä–æ–µ.",
    "–ñ–∏–∑–Ω—å –º—è–≥—á–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–¢–≤–æ—ë —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ‚Äî —É–∂–µ –ø–æ–±–µ–¥–∞.",
    "–í—Å—ë –Ω—É–∂–Ω–æ–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–æ–≤—Ä–µ–º—è.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø—Ä–æ—â–µ.",
    "–°–æ–ª–Ω—Ü–µ –≤–∑–æ–π–¥—ë—Ç –∏ –¥–ª—è —Ç–µ–±—è ‚Äî —ç—Ç–æ –∑–∞–∫–æ–Ω.",
    "–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥.",
    "–ù–∞–¥–µ–∂–¥–∞ –≤—Å–µ–≥–¥–∞ –∂–∏–≤—ë—Ç —Ç–∏—à–µ –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ.",
    "–í—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å—Ä–∞–∑—É.",
    "–¢—ã –∏–¥—ë—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç—ë–º.",
    "–°–µ–≥–æ–¥–Ω—è —É–∂–µ —Ö–æ—Ä–æ—à –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –æ–Ω –µ—Å—Ç—å.",
    "–î–æ–±—Ä–æ–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ä—è–¥–æ–º ‚Äî —Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –æ–±–µ—Ä–Ω—É—Ç—å—Å—è.",
    "–î–∞–∂–µ –ø–∞—É–∑–∞ ‚Äî —Ç–æ–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –ª–∞—Å–∫–∏ –º–∏—Ä—É –≤–æ–∫—Ä—É–≥.",
    "–ï—Å—Ç—å —Å–º—ã—Å–ª –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å.",
    "–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –ª—É—á—à–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–í—Å–µ–ª–µ–Ω–Ω–∞—è –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ —á–∞—â–µ, —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å.",
    "–ú–æ–∂–Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –±—ã—Ç—å –º—è–≥—á–µ.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Å—ë—Ç —Å —Å–æ–±–æ–π —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ.",
    "–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª –º–Ω–æ–≥–æ–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∑–∞–º–µ—á–∞–µ—à—å.",
    "–ö–∞–∂–¥—ã–π —Ä–∞—Å—Å–≤–µ—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç –µ—â—ë –æ–¥–∏–Ω —à–∞–Ω—Å.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–µ—à—å –±—ã—Ç—å —á—É—Ç—å –¥–æ–±—Ä–µ–µ –∫ —Å–µ–±–µ.",
    "–¢—ã –Ω–µ —Å—Ç–æ–∏—à—å –Ω–∞ –º–µ—Å—Ç–µ ‚Äî —ç—Ç–æ –≤–∏–¥–Ω–æ.",
    "–¢–µ–ø–ª–æ –≤–µ—Ä–Ω—ë—Ç—Å—è. –û–Ω–æ –∑–Ω–∞–µ—Ç –¥–æ—Ä–æ–≥—É.",
    "–¢–æ, —á—Ç–æ —Ç—ã –∏—â–µ—à—å, —Ç–æ–∂–µ –∏—â–µ—Ç —Ç–µ–±—è.",
    "–ü—É—Ç—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–µ–µ —Å –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∂–∏—Ç—å, –±–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.",
    "–¢—ã ‚Äî –ø—Ä–∏—á–∏–Ω–∞ —á—å–µ–π-—Ç–æ —É–ª—ã–±–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ–± —ç—Ç–æ–º.",
    "–í–Ω—É—Ç—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å.",
    "–î–∞–∂–µ —Ç–∏—à–∏–Ω–∞ –∏–Ω–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—Ç: ¬´–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è¬ª.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ –∑–Ω–∞—á–∏–º.",
    "–ú–∏—Ä —Å—Ç–∞–ª –±—ã —Ö—É–∂–µ –±–µ–∑ —Ç–µ–±—è ‚Äî –∑–∞–ø–æ–º–Ω–∏ —ç—Ç–æ.",
    "–°–µ–≥–æ–¥–Ω—è –∂–∏–∑–Ω—å —á—É—Ç—å-—á—É—Ç—å –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ.",
    "–¢–æ, —á—Ç–æ –≤–∞–∂–Ω–æ ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.",
    "–¢–≤–æ—ë —Å–µ—Ä–¥—Ü–µ –∑–Ω–∞–µ—Ç –ø—É—Ç—å.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Å–µ–±—è —Ö–æ—Ç—è –±—ã –∑–∞ –æ–¥–Ω–æ.",
    "–í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî —É–∂–µ —Ä–∞—Å—Ç—ë—Ç –≤–Ω—É—Ç—Ä–∏.",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –±—ã–ª –≤—á–µ—Ä–∞.",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ —Ç—Ä–µ–≤–æ–≥–∏.",
    "–°–∫–æ—Ä–æ —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥—á–µ.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å —Ç–æ–∂–µ –ø—Ä–∏–Ω–µ—Å—ë—Ç –ø–æ–ª—å–∑—É.",
    "–¢–≤–æ—è –¥–æ–±—Ä–æ—Ç–∞ –¥–µ–ª–∞–µ—Ç –º–∏—Ä –ª—É—á—à–µ.",
    "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å—Å—É.",
    "–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–æ—Ö–Ω—É—Ç—å.",
    "–¢—ã –¥–≤–∏–∂–µ—à—å—Å—è –≤–ø–µ—Ä—ë–¥ –¥–∞–∂–µ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Å—Ç–æ–∏—à—å.",
    "–î–ª—è —Å–≤–µ—Ç–∞ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –º–µ—Å—Ç–æ.",
    "–¢—ã —É–º–µ–µ—à—å –±–æ–ª—å—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å.",
    "–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –±—É–¥–µ—Ç –∫ —Ç–µ–±–µ –º—è–≥—á–µ.",
    "–í—Å–µ–ª–µ–Ω–Ω–∞—è –ª—é–±–∏—Ç —Ç–µ—Ö, –∫—Ç–æ –Ω–µ —Å–¥–∞—ë—Ç—Å—è.",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —Ö–æ—Ä–æ—à–µ–≥–æ –±–µ–∑ —É—Å–ª–æ–≤–∏–π.",
    "–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ –Ω–µ—Å—ë—Ç —Ç–µ–±–µ —á—Ç–æ-—Ç–æ —Ç—ë–ø–ª–æ–µ.",
    "–ú–æ–∂–Ω–æ –æ–ø–µ—Ä–µ—Ç—å—Å—è –Ω–∞ —Ç–∏—à–∏–Ω—É.",
    "–•–æ—Ä–æ—à–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–∑–Ω—É—Ç—Ä–∏.",
    "–ü—É—Å—Ç—å —Ç–≤–æ–π –º–∏—Ä —Å–µ–≥–æ–¥–Ω—è —Å—Ç–∞–Ω–µ—Ç —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ.",
    "–¢–µ–ø–ª–æ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω—ë—Ç—Å—è.",
    "–¢—ã —É–∂–µ –¥–µ–ª–∞–µ—à—å –≤—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ–µ.",
    "–°–µ–≥–æ–¥–Ω—è —É —Ç–µ–±—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ.",
    "–ö–∞–∂–¥—ã–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥ ‚Äî –ø–æ–±–µ–¥–∞.",
    "–¢—ã –Ω–µ –æ–¥–∏–Ω ‚Äî –º–∏—Ä –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è.",
    "–ñ–∏–∑–Ω—å –≤—Å—ë –µ—â—ë —Å–ø–æ—Å–æ–±–Ω–∞ –ø—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–ª—è—Ç—å.",
    "–°–∏–ª —Ö–≤–∞—Ç–∏—Ç. –î–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è –∏–Ω–∞—á–µ.",
    "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π —Ä–∞–¥–æ—Å—Ç–∏.",
    "–¢–≤–æ–π –ø—É—Ç—å –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.",
    "–•–æ—Ä–æ—à–µ–µ —É–∂–µ –≤ –ø—É—Ç–∏.",
    "–ú–æ–∂–Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –≤–µ—Ä–∏—Ç—å —á—É—Ç—å –±–æ–ª—å—à–µ.",
    "–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª—É—á—à–µ.",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –¥–æ–±—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.",
    "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å —É–∂–µ –ª—É—á—à–µ, —á–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–π."
]

# ---------------------------------------------------------
# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
# ---------------------------------------------------------

def load_data():
    if not os.path.exists(DATA_FILE):
        return {}
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# ---------------------------------------------------------
# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# ---------------------------------------------------------

def get_user(user_id: int):
    data = load_data()
    uid = str(user_id)

    if uid not in data:
        data[uid] = {
            "last_wish_date": None,
            "last_wish_text": None,
            "last_streak_date": None,
            "streak": 0,
            "total_wishes": 0
        }
        save_data(data)

    return data, data[uid]

# ---------------------------------------------------------
# –ú–µ–Ω—é
# ---------------------------------------------------------

def main_menu():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚ú® –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ", callback_data="get_wish")]
        ]
    )

# ---------------------------------------------------------
# –ö–æ–º–∞–Ω–¥–∞ /start
# ---------------------------------------------------------

@dp.message(Command("start"))
async def start_cmd(message):
    await message.answer(
        "‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n"
        "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç—ë–ø–ª–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ.\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
        reply_markup=main_menu()
    )

# ---------------------------------------------------------
# –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∂–µ–ª–∞–Ω–∏—è
# ---------------------------------------------------------

@dp.callback_query(lambda q: q.data == "get_wish")
async def process_get_wish(query: CallbackQuery):
    user_id = query.from_user.id
    now = datetime.now().date()

    data, user = get_user(user_id)

    # –û—Å–æ–±—ã–π —Ä–µ–∂–∏–º ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    ignore_limit = user_id == OWNER_ID

    # ‚ú® –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    if not ignore_limit and user["last_wish_date"] == now.isoformat():
        wish = user["last_wish_text"]

        await query.message.answer(
            f"–ü–æ–∂–µ–ª–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ:\n\n"
            f"¬´{wish}¬ª\n\n"
            f"–í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∑–∞–≤—Ç—Ä–∞ üíõ",
            reply_markup=main_menu()
        )
        return

    # ‚ú® –í—ã–¥–∞—ë–º –Ω–æ–≤–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ
    import random
    wish = random.choice(WISHES)

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    user["last_wish_date"] = now.isoformat()
    user["last_wish_text"] = wish
    user["total_wishes"] += 1

    # –°—Ç—Ä–∏–∫
    if user["last_streak_date"] is not None:
        last_date = datetime.fromisoformat(user["last_streak_date"]).date()
        if (now - last_date).days == 1:
            user["streak"] += 1
        else:
            user["streak"] = 1
    else:
        user["streak"] = 1

    user["last_streak_date"] = now.isoformat()

    save_data(data)

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await query.message.answer(
        f"¬´{wish}¬ª\n\n"
        f"üî• –°—Ç—Ä–∏–∫: {user['streak']} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥\n"
        f"üìä –í—Å–µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏–π: {user['total_wishes']}",
        reply_markup=main_menu()
    )

# ---------------------------------------------------------
# –°—Ç–∞—Ä—Ç
# ---------------------------------------------------------

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())



